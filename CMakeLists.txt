cmake_minimum_required(VERSION 3.10)

project(felis)

#=======================================================================================================================
#
#=======================================================================================================================

#add_subdirectory(gopp)
#add_subdirectory(json11)
#add_subdirectory(masstree)
#add_subdirectory(spdlog)

add_executable(db
        main.cc module.cc
        epoch.cc routine_sched.cc txn.cc log.cc vhandle.cc vhandle_sync.cc contention_manager.cc locality_manager.cc
        gc.cc index.cc mem.cc
        piece.cc masstree_index_impl.cc hashtable_index_impl.cc
        node_config.cc console.cc console_client.cc
        commit_buffer.cc shipping.cc entity.cc iface.cc slice.cc tcp_node.cc
        felis_probes.cc
        xxHash/xxhash.c util/os_linux.cc util/locks.cc
        pwv_graph.cc
        benchmark/ycsb/ycsb.cc
        benchmark/ycsb/ycsb_workload.cc
        benchmark/ycsb/ycsb_priority.cc
        benchmark/tpcc/tpcc.cc
        benchmark/tpcc/tpcc_workload.cc
        benchmark/tpcc/new_order.cc
        benchmark/tpcc/payment.cc
        benchmark/tpcc/delivery.cc
        benchmark/tpcc/order_status.cc
        benchmark/tpcc/stock_level.cc
        gopp/gopp.cc
        gopp/channels.cc
        gopp/start-x86_64.S
        )

target_include_directories(db PUBLIC ./)

#=======================================================================================================================
# Doxygen Documentation
#=======================================================================================================================

find_package(Doxygen)
if (DOXYGEN_FOUND)
  message(STATUS "Doxygen Found.")

  # Search for plantUML for creating UML diagrams from doxygen
  find_program(PLANT_UML_PATH plantuml.jar PATH_SUFFIXES PlantUML plantuml Plantuml 
    PATHS /usr/share /usr/local/share/ /usr/local/bin)
  if(NOT PLANT_UML_PATH)
    message(WARNING "Looking for PlantUML - not found, some UML diagrams will not be generated via doxygen.")
  else()
    message(STATUS "  + PlantUML - for custom UML             YES ")
  endif()

  #Search for DOT for autogenerated UML diagrams from doxygen
  find_program(DOT_PATH dot PATH_SUFFIXES graphviz2.38/bin graphviz/bin)
  if(NOT DOT_PATH)
    message(WARNING "Looking for DOT (Graphviz) - not found, some UML diagrams will not be generated via doxygen.")
  else()
    message(STATUS "  + Graphviz/Dot - for generated graphs   YES ")
  endif()

  # configure doxygen configuration file
  set(doxyfile_in ${CMAKE_CURRENT_SOURCE_DIR}/doxygen/Doxyfile.in)
  set(doxyfile ${CMAKE_CURRENT_BINARY_DIR}/Doxyfile)
  configure_file(${doxyfile_in} ${doxyfile} @ONLY)

  add_custom_target(doxygen
    COMMAND ${DOXYGEN_EXECUTABLE} ${doxyfile}
    WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
    COMMENT "Generating API documentation with Doxygen"
    VERBATIM)

else()
  message(ERROR "Doxygen not Found.")

endif()
